# ============================================================================
# WORKFLOW CI/CD SEGURO - GARANTE QUALIDADE ANTES DO DEPLOY
# ============================================================================
# 
# Este workflow implementa um padrÃ£o seguro onde:
# 1. TODOS os testes DEVEM passar antes de qualquer deploy
# 2. Linting e auditoria de seguranÃ§a sÃ£o obrigatÃ³rios
# 3. Deploy sÃ³ acontece apÃ³s validaÃ§Ã£o completa
# 4. Ambientes separados (staging/production) com validaÃ§Ãµes especÃ­ficas
# ============================================================================

name: ğŸš€ CI/CD Pipeline Seguro

# ============================================================================
# TRIGGERS - QUANDO O WORKFLOW EXECUTA
# ============================================================================
on:
  # Push direto nas branches principais
  push:
    branches: [ main, development ]
    # Ignora mudanÃ§as em arquivos que nÃ£o afetam o cÃ³digo
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'
  
  # Pull Requests para branches principais
  pull_request:
    branches: [ main, development ]
    # Ignora mudanÃ§as em arquivos que nÃ£o afetam o cÃ³digo
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE.md'

# ============================================================================
# JOBS - TAREFAS EXECUTADAS EM PARALELO OU SEQUÃŠNCIA
# ============================================================================

jobs:
  # ============================================================================
  # JOB 1: VALIDAÃ‡ÃƒO DE QUALIDADE (OBRIGATÃ“RIO)
  # ============================================================================
  # Este job DEVE passar antes de qualquer deploy
  # Executa: linting, testes, cobertura, auditoria de seguranÃ§a
  # ============================================================================
  quality-gate:
    name: ğŸ” ValidaÃ§Ã£o de Qualidade
    runs-on: ubuntu-latest
    
    # EstratÃ©gia para garantir que o job seja confiÃ¡vel
    strategy:
      fail-fast: false  # Continua executando outros jobs mesmo se um falhar
      matrix:
        node-version: [18]  # VersÃ£o especÃ­fica do Node.js
    
    steps:
      # PASSO 1: Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          # Baixa o histÃ³rico completo para melhor anÃ¡lise
          fetch-depth: 0
      
      # PASSO 2: Setup do Node.js
      - name: âš™ï¸ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # Cache das dependÃªncias para acelerar builds
      
      # PASSO 3: Instalar dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias
        run: |
          echo "ğŸ” Verificando versÃ£o do npm..."
          npm --version
          echo "ğŸ“¦ Instalando dependÃªncias..."
          npm ci --prefer-offline --no-audit
          echo "âœ… DependÃªncias instaladas com sucesso!"
      
      # PASSO 4: Verificar vulnerabilidades CRÃTICAS
      - name: ğŸ›¡ï¸ Auditoria de SeguranÃ§a (CrÃ­ticas)
        run: |
          echo "ğŸ” Verificando vulnerabilidades crÃ­ticas..."
          npm audit --audit-level=critical || {
            echo "âŒ Vulnerabilidades CRÃTICAS encontradas!"
            echo "ğŸš¨ O deploy foi BLOQUEADO por questÃµes de seguranÃ§a."
            exit 1
          }
          echo "âœ… Nenhuma vulnerabilidade crÃ­tica encontrada!"
      
      # PASSO 5: Executar linting
      - name: ğŸ§¹ Executar linting
        run: |
          echo "ğŸ§¹ Executando ESLint..."
          npm run lint || {
            echo "âŒ Problemas de linting encontrados!"
            echo "ğŸš¨ Corrija os erros de estilo antes do deploy."
            exit 1
          }
          echo "âœ… Linting passou com sucesso!"
      
      # PASSO 6: Executar testes unitÃ¡rios
      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: |
          echo "ğŸ§ª Executando testes unitÃ¡rios..."
          npm test -- --coverage --bail --watchAll=false || { 
            echo "âŒ Testes unitÃ¡rios falharam!"
            echo "ğŸš¨ Corrija os testes antes do deploy."
            exit 1
          }
          echo "âœ… Todos os testes unitÃ¡rios passaram!"
      
      # PASSO 7: Verificar cobertura de testes
      - name: ğŸ“Š Verificar cobertura de testes
        run: |
          echo "ğŸ“Š Verificando cobertura de testes..."
          npx jest --coverage --coverageReporters=json-summary --coverageReporters=text --bail --watchAll=false

          # Extrai o valor da cobertura total de linhas do JSON gerado
          COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)

          if [ -z "$COVERAGE" ]; then
            echo "âŒ NÃ£o foi possÃ­vel determinar a cobertura de testes!"
            exit 1
          fi

          echo "ğŸ“ˆ Cobertura atual: ${COVERAGE}%"

          # Converte cobertura para nÃºmero inteiro para comparaÃ§Ã£o
          COVERAGE_NUM=$(printf "%.0f" "$COVERAGE")

          if [ "$COVERAGE_NUM" -lt 80 ]; then
            echo "âŒ Cobertura de testes abaixo de 80% (atual: ${COVERAGE}%)"
            echo "ğŸš¨ Aumente a cobertura de testes antes do deploy."
            exit 1
          fi

          echo "âœ… Cobertura de testes adequada (${COVERAGE}%)"
      
      # PASSO 8: Upload relatÃ³rio de cobertura
      - name: ğŸ“¤ Upload cobertura para Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false  # NÃ£o falha o CI se Codecov der erro
      
      # PASSO 9: Build do projeto (validaÃ§Ã£o final)
      - name: ğŸ”¨ Build do projeto
        run: |
          echo "ğŸ”¨ Executando build do projeto..."
          npm run build || {
            echo "âŒ Build falhou!"
            echo "ğŸš¨ Corrija os erros de build antes do deploy."
            exit 1
          }
          echo "âœ… Build executado com sucesso!"
      
      # PASSO 10: Verificar vulnerabilidades MODERADAS
      - name: ğŸ›¡ï¸ Auditoria de SeguranÃ§a (Moderadas)
        run: |
          echo "ğŸ” Verificando vulnerabilidades moderadas..."
          npm audit --audit-level=moderate || {
            echo "âš ï¸ Vulnerabilidades moderadas encontradas!"
            echo "ğŸ’¡ Considere atualizar as dependÃªncias afetadas."
            # NÃ£o falha o build, apenas avisa
          }
          echo "âœ… Auditoria de seguranÃ§a concluÃ­da!"

  # ============================================================================
  # JOB 2: DEPLOY PARA STAGING (APENAS SE QUALITY-GATE PASSAR)
  # ============================================================================
  # Executa apenas na branch development
  # Ambiente de teste antes da produÃ§Ã£o
  # ============================================================================
  deploy-staging:
    name: ğŸš€ Deploy para Staging
    runs-on: ubuntu-latest
    
    # DEPENDÃŠNCIA CRÃTICA: sÃ³ executa se quality-gate passar
    needs: quality-gate
    
    # SÃ³ executa na branch development
    if: github.ref == 'refs/heads/development'
    
    steps:
      # PASSO 1: Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      # PASSO 2: Setup do Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # PASSO 3: Instalar dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      # PASSO 4: Build do projeto
      - name: ğŸ”¨ Build do projeto
        run: npm run build
      
      # PASSO 5: Deploy para Vercel (Staging)
      - name: ğŸš€ Deploy para Vercel (Staging)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # Argumentos especÃ­ficos para staging
          vercel-args: '--target=preview'
      
      # PASSO 6: NotificaÃ§Ã£o de sucesso
      - name: âœ… Notificar deploy de staging
        run: |
          echo "ğŸ‰ Deploy para staging concluÃ­do com sucesso!"
          echo "ğŸ”— URL: https://staging-seu-projeto.vercel.app"

  # ============================================================================
  # JOB 3: DEPLOY PARA PRODUÃ‡ÃƒO (APENAS SE QUALITY-GATE PASSAR)
  # ============================================================================
  # Executa apenas na branch main
  # Ambiente de produÃ§Ã£o com validaÃ§Ãµes extras
  # ============================================================================
  deploy-production:
    name: ğŸš€ Deploy para ProduÃ§Ã£o
    runs-on: ubuntu-latest
    
    # DEPENDÃŠNCIA CRÃTICA: sÃ³ executa se quality-gate passar
    needs: quality-gate
    
    # SÃ³ executa na branch main
    if: github.ref == 'refs/heads/main'
    
    # Ambiente de produÃ§Ã£o com proteÃ§Ãµes
    environment: 
      name: production
      url: https://seu-projeto.vercel.app
    
    steps:
      # PASSO 1: Checkout do cÃ³digo
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      # PASSO 2: Setup do Node.js
      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # PASSO 3: Instalar dependÃªncias
      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci
      
      # PASSO 4: Build do projeto
      - name: ğŸ”¨ Build do projeto
        run: npm run build
      
      # PASSO 5: ValidaÃ§Ã£o extra para produÃ§Ã£o
      - name: ğŸ” ValidaÃ§Ã£o extra para produÃ§Ã£o
        run: |
          echo "ğŸ” Executando validaÃ§Ãµes extras para produÃ§Ã£o..."
          
          # Verifica se nÃ£o hÃ¡ console.log em produÃ§Ã£o
          if grep -r "console.log" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx"; then
            echo "âš ï¸ Console.log encontrado no cÃ³digo!"
            echo "ğŸ’¡ Considere remover antes do deploy para produÃ§Ã£o."
          fi
          
          # Verifica tamanho do build
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ğŸ“¦ Tamanho do build: $BUILD_SIZE"
          
          echo "âœ… ValidaÃ§Ãµes extras concluÃ­das!"
      
      # PASSO 6: Deploy para Vercel (ProduÃ§Ã£o)
      - name: ğŸš€ Deploy para Vercel (ProduÃ§Ã£o)
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          # Argumentos especÃ­ficos para produÃ§Ã£o
          vercel-args: '--prod'
      
      # PASSO 7: NotificaÃ§Ã£o de sucesso
      - name: âœ… Notificar deploy de produÃ§Ã£o
        run: |
          echo "ğŸ‰ Deploy para produÃ§Ã£o concluÃ­do com sucesso!"
          echo "ğŸ”— URL: https://seu-projeto.vercel.app"
          echo "ğŸ“Š Monitoramento ativo para detectar problemas."

  # ============================================================================
  # JOB 4: NOTIFICAÃ‡Ã•ES (OPCIONAL)
  # ============================================================================
  # Envia notificaÃ§Ãµes sobre o status do pipeline
  # ============================================================================
  notifications:
    name: ğŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    
    # Executa sempre, independente do resultado dos outros jobs
    needs: [quality-gate, deploy-staging, deploy-production]
    
    # SÃ³ executa se pelo menos um job foi executado
    if: always()
    
    steps:
      - name: ğŸ“Š Resumo do pipeline
        run: |
          echo "ğŸ“Š Resumo do Pipeline CI/CD:"
          echo "âœ… Quality Gate: ${{ needs.quality-gate.result }}"
          echo "âœ… Deploy Staging: ${{ needs.deploy-staging.result }}"
          echo "âœ… Deploy Production: ${{ needs.deploy-production.result }}"
          
          if [ "${{ needs.quality-gate.result }}" == "success" ]; then
            echo "ğŸ‰ Pipeline executado com sucesso!"
          else
            echo "âŒ Pipeline falhou na validaÃ§Ã£o de qualidade."
          fi